{% extends "default.html" %}
{% load i18n %}
{% load extras %}

{% block title %}{% trans "Huoltotilaus" %}{% endblock title %}

{% block toolbar %}
<ul class="navigation">
    <li>
        <a class="popup customer" href="/customer/create/order/{{ order.id }}">{% trans 'Asiakas' %}</a>
    </li>
    <li>
        <a class="popup device" href="/device/create/order/{{ order.id }}">{% trans 'Laite' %}</a>
    </li>
    <li>
        <a class="popup issue" href="/issue/create/order/{{ order.id }}">{% trans 'Tehtävä' %}</a>
    </li>
    <li>
        <a class="popup product" href="/products/create/order/{{ order.id }}">{% trans 'Tuote' %}</a>
    </li>
    <li>
        <a class="popup message" href="/message/create/order/{{ order.id }}">{% trans 'Viesti' %}</a>
    </li>
</ul>
{% endblock %}

{% block sidebar %}

<div class="block_header"><p style="padding:10px"><a href="/orders/">Servo &gt; </a><a href="/orders/edit/{{ order.id }}">{{ order.number }}</a></p></div>
<div style="padding:5px" class="droppable">
    <span class="label">{% trans 'Jono' %}</span>
    <select name="set_queue">
      <option value="">{% trans "Valitse" %}...</option>
{% for queue in queues %}
      <option value="{{ queue.id }}">{{ queue.title }}</option>
{% endfor %}
    </select>
    <br/>
    <span class="label">{% trans 'Status' %}</span>
    <select name="set_status">
      <option value="">{% trans "Valitse" %}...</option>
{% for status in statuses %}
      <option value="{{ status.id }}">{{ status.title }}</option>
{% endfor %}
    </select>
    <br/>
    <span class="label">{% trans 'Käsittelijä' %}</span>
    <select name="set_user">
      <option value="">{% trans "Valitse" %}...</option>
{% for user in users %}
      <option value="{{ user.id }}">{{ user.fullname }}</option>
{% endfor %}
    </select>
    <br/>
    <span class="label">{% trans 'Prioriteetti' %}</span>
    <select name="set_priority">
      <option value="">{% trans "Valitse" %}...</option>
{% for prio in priorities %}
      <option value="{{ queue.id }}">{{ queue.title }}</option>
{% endfor %}
    </select>
    <hr/>
    <div id="tags" data-url="/orders/tags/{{ order.id }}" style="border-bottom:none">

      <ul>
{% for tag in order.tags %}
  <li class="draggable"><a href="/orders/index/tag/{{ tag }}">{{ tag }}</a></li>
{% endfor %}
      </ul>
      
      <div id="newTagTarget"><a class="tag" id="add_tag" href="/tag/create/order">{% trans "Lisää" %}</a></div>

      <script type="text/javascript">
          $(".draggable").draggable({
              revert: "invalid",
              zIndex: 1000,
              opacity: 0.5
          });

          $("#add_tag").click(function(e) {
              e.preventDefault();
              $("#newTagTarget").load($(this).attr("href"), {
                action: "/orders/tags/{{ order.id }}"
              });
          });

          $(".droppable").droppable({
              drop: function(event, ui) {
                  ui.draggable.fadeOut();
                  $.post($("#tags").data("url"),
                      {action: "remove", title: ui.draggable.text()}
                  );
              }
          });
      </script>
      
    </div>
    <br/><hr/>

    <div id="customers" class="customerDetails" data-url="/orders/customer/id/{{ order.id }}">
        <a href="/customer/edit/{{ order.customer.id }}" class="popup"><h3>{{ order.customer.name }}</h3></a>
        
{% for k, v in order.customer.fullprops.items %}
  
  <p>{{ v|clickable }}</p>
  
{% endfor %}
    
    <hr/>
    </div>

    <form id="miniform" method="post" action="/message/save">
      {% csrf_token %}
      <input type="hidden" name="order" value="{{ order.id }}"/>
      <span class="label">{% trans 'Pikaviesti' %}</span>
      <textarea name="body" id="minimessage"></textarea>
    </form>
    <div class="buttons">
        <a href="javascript:;" class="save button"><span>{% trans 'Tallenna' %}</span></a>
        <a href="/orders/follow/{{ order.id }}" class="follow button"><span>{% trans "Seuraa" %}</span></a>
    </div>
</div>


{% endblock %}

{% block content %}

<div id="devices" class="tableView" data-url="/orders/devices/{{ order.id }}">

	<table>
		<thead>
			<tr>
				<th colspan="2">{% trans 'Laitteet' %}</th>
				<th>{% trans 'Käyttäjä' %}</th>
				<th>{% trans 'Salasana' %}</th>
				<th>{% trans 'MRI status' %}</th>
			</tr>
		</thead>
		<tbody data-collection="device">

{% for device in order.devices %}
  
  <tr data-url="/device/edit/{{ device.id }}" class="<?php print $this->cycle(array('', 'even'))->next() ?>">
  	<td><a href="/device/edit/id/<?php print $d['_id'] ?>" class="popup">{{ device.sn }}</a></td>
  	<td>{{ device.description }}</td>
  	<td>{{ device.username }}</td>
  	<td>{{ device.password }}</td>
  	<td><a href="/device/mri/sn/{{ device.sn }}">{% trans "Tuntematon" %}</a></td>
  </tr>
  
{% endfor %}

		</tbody>
	</table>

</div>

<div id="issues" class="tableView" data-url="/orders/issues/{{ order.id }}">
    <table>
        <thead><tr><th colspan="4">{% trans 'Tehtävät' %}</th></tr></thead>
        <tbody data-collection="orders">

{% for issue in order.issues %}
  
<tr class="{% cycle 'odd' 'even' %}" data-url="/issue/edit/{{ issue.id }}">
    <td>
        <span class="user">{{ issue.created_by }}</span>
        <span class="date">{{ issue.created_at|relative_date }}</span>
        {{ issue.symptom }}
{% if issue.diagnosis %}
        <hr/>
        {{ issue.diagnosis }}
        <span class="small">{{ issue.diagnosed_by }} @ {{ issue.diagnosed_at|relative_date }}</span>
{% endif %}
      
{% if issue.solution %}

  <hr/>
  {{ issue.solution }}
  <span class="small">{{ issue.solved_by }} @ {{ solved_at|relative_date }}</span>  

{% endif %}
      
        </td>
    </tr> 
  
{% endfor %}

        </tbody>
    </table>

</div><!-- //#issues -->

<div class="tableView" id="messages" data-url="/orders/messages/{{ order.id }}">

	<table>
		<thead><tr><th>{% trans 'Viestit' %}</th></tr></thead>
		<tbody>

{% for msg in order.messages %}

        <tr data-url="/message/edit/{{ msg.id }}" class="{% cycle 'odd' 'even' %}">
            <td style="padding-left:{{ msg.indent }}em">
                <span class="user">{{ msg.sender }}</span>
                <span class="date">{{ msg.created_at|relative_date }}</span>        
                {% if msg.mailto %}<span class="email">{{ msg.mailto }}</span>{% endif %}<br/>
                {{ msg.body }}
                {% for file in msg.attachments %}
                  <a class="window attachment" href="/attachment/{{ file.id }}">{{ file.name }}</a>
                {% endfor %}
            </td>
        </tr>
        
{% endfor %}

		</tbody>
	</table>

</div>

<div id="products" class="tableView" data-url="/orders/products/id/{{ order.id }}">

    <table>
        <thead><tr><th colspan="5">{% trans "Tuotteet" %}</th></tr></thead>
        <tbody data-collection="orders">
{% for product in order.products %}
      <tr data-url="/products/edit/order/<?php print $this->order['_id'] ?>/idx/<?php print $k ?>"
          class="{% cycle 'odd' 'even' %}">
          <td><a href="/products/edit/order/<?php print $this->order['_id'] ?>/idx/<?php print $k ?>" class="popup">{{ product.number }}</a></td>
          <td>{{ product.title }}</td>
          <td>{{ product.price_sales }}</td>
          <td><a href="/purchase-order/view/id/" class="popup">20116</a></td>
          <td><a href="/orders/report/product/<?php print $k ?>" class="async report"></a></td>
      </tr>  
{% endfor %}
        </tbody>
    </table>
</div>
<!-- //#products -->

<div id="events" data-url="/orders/events/id/{{ order.id }}">
<table>
    <thead>
        <tr><th colspan="3">{% trans "Tapahtumat" %}</th></tr>
    </thead>
    <tbody>
{% for event in order.events %}
      <tr class="{% cycle 'odd' 'even' %}">
          <td><img src="/static/images/event-{{ event.type }}.png" alt="{{ event.description }}" class="icon"/></td>
          <td style="width:55%">{{ event.description }}</td>
          <td>{{ event.created_by }} @ {{ event.created_at|relative_date }}</td>
      </tr>
{% endfor %}
    </tbody>
</table>
</div>

{% endblock %}
